# GitLab CI/CD Pipeline for FOST SDK Generation and Publishing

stages:
  - detect
  - generate
  - validate
  - publish
  - release
  - notify

variables:
  NODE_VERSION: "18"
  REGISTRY: "registry.gitlab.com"
  IMAGE: "$REGISTRY/$CI_PROJECT_PATH"

# Base job configuration
.base_job:
  image: node:18-alpine
  before_script:
    - npm ci
    - npm run build

# ============================================================================
# Stage 1: Detect Changes
# ============================================================================

detect_spec_changes:
  stage: detect
  image: alpine:latest
  script:
    - |
      if [ "$CI_PIPELINE_SOURCE" == "merge_request_event" ]; then
        # MR: detect changes from base branch
        echo "Merge Request Pipeline - Detecting changes..."
        git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
        changed_specs=$(git diff --name-only origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD | grep -E "api-specs/.*\.(json|yaml)" || echo "")
      elif [ "$CI_PIPELINE_SOURCE" == "web" ] || [ "$CI_PIPELINE_SOURCE" == "api" ]; then
        # Manual trigger
        echo "Manual Pipeline Trigger"
        changed_specs=$(ls api-specs/*.{json,yaml} 2>/dev/null || echo "")
      else
        # Push event: detect from previous commit
        if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
          changed_specs=$(git diff --name-only HEAD~1 | grep -E "api-specs/.*\.(json|yaml)" || echo "")
        else
          changed_specs=$(git diff --name-only $CI_DEFAULT_BRANCH...HEAD | grep -E "api-specs/.*\.(json|yaml)" || echo "")
        fi
      fi
      
      if [ -n "$changed_specs" ]; then
        echo "$changed_specs" > /tmp/changed_specs.txt
        echo "Changed specs:"
        cat /tmp/changed_specs.txt
      else
        echo "No API spec changes detected"
        echo "" > /tmp/changed_specs.txt
      fi
  artifacts:
    paths:
      - /tmp/changed_specs.txt
    expire_in: 1 hour
  allow_failure: true

# ============================================================================
# Stage 2: Generate SDKs (Dynamic Matrix)
# ============================================================================

.generate_base:
  stage: generate
  extends: .base_job
  needs: ["detect_spec_changes"]
  dependencies:
    - detect_spec_changes
  script:
    - |
      spec_file="$SPEC_FILE"
      sdk_name=$(basename "$spec_file" | sed 's/\.[^.]*$//')
      
      # Detect API type
      if grep -q "\"ethereum\"" "$spec_file" || grep -q "\"solidity\"" "$spec_file"; then
        api_type="web3"
      elif grep -q "\"query\"" "$spec_file"; then
        api_type="graphql"
      else
        api_type="web2"
      fi
      
      echo "SDK Name: $sdk_name"
      echo "API Type: $api_type"
      echo "Language: $SDK_LANGUAGE"
      
      # Generate SDK
      mkdir -p "generated-sdks/$sdk_name/$SDK_LANGUAGE"
      npm run cli -- generate \
        --input "$spec_file" \
        --language "$SDK_LANGUAGE" \
        --type "$api_type" \
        --output "generated-sdks/$sdk_name/$SDK_LANGUAGE" \
        --docs \
        --examples \
        --validate
  artifacts:
    paths:
      - generated-sdks/
    expire_in: 1 week

generate_typescript:
  extends: .generate_base
  variables:
    SDK_LANGUAGE: "typescript"
    SPEC_FILE: "api-specs/example-api.json"  # Override in pipeline
  only:
    - merge_requests
    - main
    - develop

generate_python:
  extends: .generate_base
  variables:
    SDK_LANGUAGE: "python"
    SPEC_FILE: "api-specs/example-api.json"  # Override in pipeline
  only:
    - merge_requests
    - main
    - develop

generate_go:
  extends: .generate_base
  variables:
    SDK_LANGUAGE: "go"
    SPEC_FILE: "api-specs/example-api.json"  # Override in pipeline
  only:
    - merge_requests
    - main
    - develop

# ============================================================================
# Stage 3: Validate Generated Code
# ============================================================================

validate_typescript:
  stage: validate
  image: node:18-alpine
  needs: ["generate_typescript"]
  dependencies:
    - generate_typescript
  script:
    - |
      for sdk_dir in generated-sdks/*/typescript; do
        if [ -d "$sdk_dir" ] && [ -f "$sdk_dir/package.json" ]; then
          echo "Validating TypeScript SDK: $sdk_dir"
          cd "$sdk_dir"
          npm install --prefer-offline
          npm run build
          npm run test 2>/dev/null || true
          cd -
        fi
      done
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

validate_python:
  stage: validate
  image: python:3.10-alpine
  needs: ["generate_python"]
  dependencies:
    - generate_python
  script:
    - |
      apk add --no-cache py3-pip
      for sdk_dir in generated-sdks/*/python; do
        if [ -d "$sdk_dir" ] && [ -f "$sdk_dir/setup.py" ]; then
          echo "Validating Python SDK: $sdk_dir"
          cd "$sdk_dir"
          python -m pip install -e . 2>/dev/null || true
          python -m py_compile *.py
          cd -
        fi
      done
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

validate_go:
  stage: validate
  image: golang:1.21-alpine
  needs: ["generate_go"]
  dependencies:
    - generate_go
  script:
    - |
      apk add --no-cache git
      for sdk_dir in generated-sdks/*/go; do
        if [ -d "$sdk_dir" ] && [ -f "$sdk_dir/go.mod" ]; then
          echo "Validating Go SDK: $sdk_dir"
          cd "$sdk_dir"
          go mod download
          go vet ./...
          cd -
        fi
      done
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================================================
# Stage 4: Publish to Package Managers
# ============================================================================

publish_npm:
  stage: publish
  image: node:18-alpine
  needs: ["validate_typescript"]
  dependencies:
    - validate_typescript
  script:
    - |
      echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
      for sdk_dir in generated-sdks/*/typescript; do
        if [ -d "$sdk_dir" ] && [ -f "$sdk_dir/package.json" ]; then
          echo "Publishing TypeScript SDK: $sdk_dir"
          cd "$sdk_dir"
          npm ci
          npm publish --access public || echo "Package already published or error occurred"
          cd -
        fi
      done
  only:
    - main
  when: manual

publish_pypi:
  stage: publish
  image: python:3.10-alpine
  needs: ["validate_python"]
  dependencies:
    - validate_python
  script:
    - |
      apk add --no-cache python3-dev gcc musl-dev
      pip install build twine
      for sdk_dir in generated-sdks/*/python; do
        if [ -d "$sdk_dir" ] && [ -f "$sdk_dir/setup.py" ]; then
          echo "Publishing Python SDK: $sdk_dir"
          cd "$sdk_dir"
          python -m build
          python -m twine upload dist/* --skip-existing \
            -u __token__ -p $PYPI_TOKEN
          cd -
        fi
      done
  only:
    - main
  when: manual

# ============================================================================
# Stage 5: Create Release
# ============================================================================

create_release:
  stage: release
  image: alpine:latest
  needs:
    - generate_typescript
    - generate_python
    - generate_go
  script:
    - |
      apk add --no-cache curl jq git
      
      # Generate release notes
      timestamp=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
      release_body="## FOST SDK Generation Report\n\n**Generated:** $timestamp\n**Commit:** $CI_COMMIT_SHA\n\n### Generated SDKs\n"
      
      for sdk_dir in generated-sdks/*/; do
        sdk_name=$(basename "$sdk_dir")
        release_body+="- **$sdk_name**: TypeScript, Python, Go\n"
      done
      
      # Create GitLab Release
      curl --request POST \
        --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        --form "tag_name=sdk-$CI_PIPELINE_ID" \
        --form "release_description=$release_body" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - main
  when: manual

# ============================================================================
# Stage 6: Notifications
# ============================================================================

notify_slack:
  stage: notify
  image: curlimages/curl:latest
  needs:
    - detect_spec_changes
  script:
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        status="${CI_JOB_STATUS}"
        branch="${CI_COMMIT_BRANCH}"
        commit="${CI_COMMIT_SHORT_SHA}"
        
        message="{\"text\": \"FOST SDK Generation\", \"blocks\": [{\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"*FOST SDK Generation*\n:github: Repository: $CI_PROJECT_PATH\n:git: Branch: $branch\n:gear: Pipeline: $CI_PIPELINE_URL\n:information_source: Status: $status\"}}]}"
        
        curl -X POST -H 'Content-type: application/json' \
          --data "$message" \
          "$SLACK_WEBHOOK_URL"
      fi
  allow_failure: true
  when: always

# ============================================================================
# Pages: Publish Documentation
# ============================================================================

pages:
  stage: publish
  image: node:18-alpine
  needs:
    - generate_typescript
  dependencies:
    - generate_typescript
  script:
    - |
      mkdir -p public
      for sdk_dir in generated-sdks/*/typescript; do
        if [ -d "$sdk_dir/docs" ]; then
          sdk_name=$(basename $(dirname "$sdk_dir"))
          cp -r "$sdk_dir/docs" "public/$sdk_name"
        fi
      done
      
      # Create index
      echo "<html><body><h1>FOST Generated SDKs</h1><ul>" > public/index.html
      for dir in public/*/; do
        name=$(basename "$dir")
        echo "<li><a href='$name/'>$name</a></li>" >> public/index.html
      done
      echo "</ul></body></html>" >> public/index.html
  artifacts:
    paths:
      - public/
  only:
    - main
